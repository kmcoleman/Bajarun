rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Headshots folder - authenticated users can upload their own photos
    match /headshots/{fileName} {
      // Anyone authenticated can read headshots (for participant page)
      allow read: if request.auth != null;

      // Users can only upload files starting with their own uid
      allow write: if request.auth != null
                   && fileName.matches(request.auth.uid + '-.*')
                   && request.resource.size < 5 * 1024 * 1024  // Max 5MB
                   && request.resource.contentType.matches('image/.*');
    }

    // Rider documents folder - users can upload to their own folder
    match /rider-documents/{userId}/{fileName} {
      // Users can read their own documents, admin can read all
      allow read: if request.auth != null
                  && (request.auth.uid == userId
                      || request.auth.uid == 'kGEO7bTgqMMsDfXmkumneI44S9H2');

      // Users can only write to their own folder
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024;  // Max 10MB
    }

    // Rider documents folder (camelCase path for mobile app)
    match /riderDocuments/{userId}/{fileName} {
      // Users can read their own documents, admin can read all
      allow read: if request.auth != null
                  && (request.auth.uid == userId
                      || request.auth.uid == 'kGEO7bTgqMMsDfXmkumneI44S9H2');

      // Users can only write to their own folder
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   && request.resource.size < 10 * 1024 * 1024;  // Max 10MB
    }

    // Product images - public read access for store
    match /products/{fileName} {
      allow read: if true;  // Public - anyone can view product images
      // Only admin can upload product images
      allow write: if request.auth != null
                   && request.auth.uid == 'kGEO7bTgqMMsDfXmkumneI44S9H2';
    }

    // Legal documents (privacy policy, terms of service) - public read
    match /legal/{fileName} {
      allow read: if true;  // Public - anyone can view legal docs
      // Only admin can upload/update legal documents
      allow write: if request.auth != null
                   && request.auth.uid == 'kGEO7bTgqMMsDfXmkumneI44S9H2';
    }

    // Event images - public read for events page
    match /eventimages/{fileName} {
      allow read: if true;  // Public - anyone can view event images
      // Only admin can upload event images
      allow write: if request.auth != null
                   && request.auth.uid == 'kGEO7bTgqMMsDfXmkumneI44S9H2';
    }

    // Gallery media - photos and videos shared by riders
    match /gallery/{eventId}/{fileName} {
      // All authenticated users can read gallery media
      allow read: if request.auth != null;

      // Authenticated users can upload media (must start with their uid)
      allow write: if request.auth != null
                   && fileName.matches(request.auth.uid + '_.*')
                   && request.resource.size < 100 * 1024 * 1024  // Max 100MB for videos
                   && (request.resource.contentType.matches('image/.*')
                       || request.resource.contentType.matches('video/.*'));
    }
  }
}
